on: [push]

name: Bundle and Publish

jobs:
  publish-version:
    environment: bundle-publish
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        settings:
          - platform: macos
            system: mac
            architecture: aarch64
            format: dmg
          - platform: macos
            system: mac
            architecture: x86_64
            format: dmg

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: 0.6.0 Bundle (${{ matrix.settings.system }}-${{ matrix.settings.architecture }})

      - name: Extract build artifacts
        run: tar -xzvf ./bundle-0.6.0-${{ matrix.settings.system }}.tar.gz

      - name: Publish application version
        uses: keithweaver/aws-s3-github-action@v1.0.0
        env:
          AWS_EC2_METADATA_DISABLED: true
        with:
          command: cp
          source: ${{ matrix.settings.format }}/
          destination: s3://${{ vars.S3_BUCKET }}/versions/0.6.0/${{ matrix.settings.platform }}/${{ matrix.settings.architecture }}/
          flags: --endpoint-url ${{ vars.S3_ENDPOINT }} --recursive --exclude "*" --include "*.${{ matrix.settings.format }}" --exclude ".*"
          aws_access_key_id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_SECRET_ACCESS_KEY }}

      - name: Publish update archive
        uses: keithweaver/aws-s3-github-action@v1.0.0
        env:
          AWS_EC2_METADATA_DISABLED: true
        with:
          command: cp
          source: ${{ matrix.settings.platform }}/
          destination: s3://${{ vars.S3_BUCKET }}/versions/0.6.0/${{ matrix.settings.platform }}/${{ matrix.settings.architecture }}/update/
          flags: --endpoint-url ${{ vars.S3_ENDPOINT }} --recursive --exclude "*" --include "*.tar.gz" --include "*.tar.gz.sig"
          aws_access_key_id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_SECRET_ACCESS_KEY }}

  publish-manifest:
    needs: [bundle, publish-version]
    environment: bundle-publish
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            src-tauri/scripts/updater.sh

      - name: Generate update manifest
        run: |
          ./src-tauri/scripts/updater.sh --endpoint=${{ vars.S3_ENDPOINT }} --bucket=${{ vars.S3_BUCKET }} --version=0.6.0 --manifest=manifest.json

      - name: Publish update manifest
        uses: keithweaver/aws-s3-github-action@v1.0.0
        env:
          AWS_EC2_METADATA_DISABLED: true
        with:
          command: cp
          source: manifest.json
          destination: s3://${{ vars.S3_BUCKET }}/updates/latest.json
          flags: --endpoint-url ${{ vars.S3_ENDPOINT }}
          aws_access_key_id: ${{ secrets.S3_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.S3_SECRET_ACCESS_KEY }}
